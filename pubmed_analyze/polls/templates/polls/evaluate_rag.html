{% extends "polls/base.html" %}

{% block title %}Evaluer un RAG{% endblock %}

{% block content %}
<h1 class="mt-4">Evaluer un RAG</h1>
<div class="mt-4"></div>
<form method="post">
    {% csrf_token %}

    <!-- Type de recherche -->
    <div class="form-group">
        {{ form.research_type.label_tag }}
        {{ form.research_type }}
    </div>
    
    <!-- Modèle -->
    <div class="form-group field-group" id="model_group">
        {{ form.model.label_tag }}
        {{ form.model }}
    </div>

    <!-- Sliders avec mise à jour dynamique -->
    {% for field in form %}
        {% if field.name in "number_of_results number_of_articles title_weight abstract_weight rank_scaling_factors" %}
            <div class="form-group field-group" id="{{ field.name }}_group">
                {{ field.label_tag }}
                {{ field }}
                <span id="{{ field.name }}_value">{{ field.value|default:0 }}</span>
            </div>
        {% endif %}
    {% endfor %}

    <button type="submit" class="btn btn-primary">Lancer l'évaluation</button>
</form>

{{ if score_retrieval }}
    <div class="mt-4"></div>
    <h2 class="text-center">Score de recherche : {{ score_retrieval }}</h2>
{% endif %}

{{ if score_generation }}
    <div class="mt-4"></div>
    <h2 class="text-center">Score de génération : {{ score_generation }}</h2>
{% endif %}

<!-- JavaScript pour la mise à jour des valeurs de slider et la visibilité des champs -->
<script>
    function updateSliderValue(fieldId) {
        const slider = document.getElementById(`id_${fieldId}`);
        const output = document.getElementById(`${fieldId}_value`);
        slider.addEventListener('input', () => output.textContent = slider.value);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const researchTypeSelect = document.getElementById('id_research_type');
        
        // Initialise les valeurs des sliders
        ['number_of_results', 'number_of_articles', 'title_weight', 'abstract_weight', 'rank_scaling_factors'].forEach(fieldId => {
            updateSliderValue(fieldId);
        });
        
        // Définit les groupes de champs à afficher pour chaque type de recherche
        const fieldGroups = {
            'neural': ['model_group', 'number_of_results_group', 'number_of_articles_group'],
            'text': ['model_group', 'number_of_results_group', 'title_weight_group', 'abstract_weight_group'],
            'hybrid': ['model_group', 'number_of_results_group', 'number_of_articles_group', 'title_weight_group', 'abstract_weight_group', 'rank_scaling_factors_group']
        };

        function toggleFields() {
            // Cache tous les groupes de champs
            document.querySelectorAll('.field-group').forEach(group => group.style.display = 'none');
            
            // Affiche les groupes pertinents selon le type de recherche sélectionné
            const selectedType = researchTypeSelect.value;
            (fieldGroups[selectedType] || []).forEach(fieldId => {
                document.getElementById(fieldId).style.display = 'block';
            });
        }

        // Initialise l'affichage des champs à la sélection du type de recherche
        researchTypeSelect.addEventListener('change', toggleFields);
        toggleFields();  // Lance l'initialisation au chargement
    });
</script>

{% endblock %}
